kind: pipeline
name: alw 0.1

trigger:
  ref:
    include:
    - refs/heads/main
    - refs/pull/**
    - refs/tags/v**

steps:
- name: helloworld
  image: alpine
  commands:
    - echo "Hello, World!"
    - ls -lR

---
kind: pipeline
name: docker
depends_on:
  - alw 0.1

trigger:
  ref:
    include:
    - refs/heads/main
    - refs/pull/**
    - refs/tags/v**

services:
- name: docker
  image: plugins/docker:24-dind
  pull: if-not-exists
  privileged: true
  network: host
  environment:
    DOCKER_TLS_VERIFY: ""
  volumes:
  - name: dockersock
    path: /var/run

steps:
- name: wait
  image: plugins/docker
  pull: if-not-exists
  network: host
  commands:
    - until docker ps; do sleep 10; done
    - sleep 10
  volumes:
  - name: dockersock
    path: /var/run

- name: push
  image: plugins/docker
  pull: if-not-exists
  network: host
  settings:
    repo:  zxr5-test-repo
    auto_tag: true
    network: host
    dockerfile: Dockerfile
    username: albal
    password:
      from_secret: DOCKER_PAT
  volumes:
  - name: dockersock
    path: /var/run
  when:
    event:
      - tag

volumes:
- name: dockersock
  temp: {}
